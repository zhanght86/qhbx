(function(){var a=function(f,c){this._render_start=f.render_start;this._data=f;this._render_timing={ht:0,vt:0,drt:0,tti:0,lt:0,fvt:0,crt:0};this._conf=c||{log_path:"http://static.tieba.baidu.com/tb/pms/img/st.gif",img_conn_path:"http://xs.tieba.baidu.com/cache_monitor",display:false};this._performance_timing={};this._metrics=[];this._readyCount=0;var e=f.timing;for(var d in e){this._render_timing[d]=e[d]}var b=this;if(document.attachEvent){window.attachEvent("onbeforeunload",function(){b.sendCpu()})}else{window.addEventListener("beforeunload",function(){b.sendCpu()},false)}this._measureScreen();this._browser();this._resources();this._cache();this._measureNetworkTime();this._measureRenderTime();this._measureCPU();this._speicalParams();this._ready()};a.prototype._speicalParams=function(){var c=window.PDC&&PDC._opt&&PDC._opt.s_params;if(c){for(var b in c){if(c.hasOwnProperty(b)){this._metrics.push("cus_"+b+"="+c[b])}}}};a.prototype._ready=function(){this._readyCount++;if(this._readyCount==2){this.send()}};a.prototype._measureScreen=function(){if(window.screen){this._metrics.push("_screen="+window.screen.width+"*"+window.screen.height+"|"+window.screen.availWidth+"*"+window.screen.availHeight)}};a.prototype._measureCPU=function(){function d(l){if(l>=0){for(var k=0;k<75;k+=25){if(l>=k&&l<k+25){return k/25}}if(l>=75&&l<500){return 3}return 4}}function j(k){var m=[0,0,0,0,0];for(var l in k){var n=d(k[l]);if(n>=0){m[n]++}}return m}var h=window.PDC&&PDC._cputimings;var c=window.PDC&&PDC._timingKeys;var g=[];if(h&&c){for(var f=0,b=h.length;f<b;f++){if(h[f]&&c[f+1]){var e=c[f]+"-"+c[f+1];g.push('"'+e+'":['+j(h[f]).join(",")+"]")}}this._metrics.push("_cpu={"+g.join(",")+"}")}else{if(PDC._cpupool&&window.CPU_MONITOR){this._metrics.push("_cpu="+CPU_MONITOR.toString(PDC._cpupool))}}};a.prototype._measureNetworkTime=function(){var c={dns:0,ct:0,st:0,tt:0};var d=0;if(window.performance&&window.performance.timing){var b=window.performance.timing;d=b.domainLookupStart;c.dns=b.domainLookupEnd;c.ct=b.connectEnd;c.st=b.responseStart;c.tt=b.responseEnd;c.dct=b.domComplete;c.olt=b.loadEventEnd}this._measureTime(d,c)};a.prototype._measureTime=function(e,c){var d=0;for(var b in c){d=c[b]>0?c[b]-e:0;this._metrics.push(b+"="+d)}};a.prototype._measureRenderTime=function(){if(window.performance&&window.performance.timing){var b=window.performance.timing;this._performance_timing=b;this._render_timing.lt=b.loadEventStart;if(b.loadEventEnd>0){this._render_timing.let=b.loadEventEnd}}if(this._render_timing.fvt==0){this._render_timing.fvt=this._render_timing.crt=this._render_timing.let}this._measureTime(this._render_start,this._render_timing)};a.prototype._resources=function(){var e=[],g={},d=null;var f=0;e=document.getElementsByTagName("img");for(var c=0,b=e.length;c<b;c++){d=e[c];if(d.src&&!(d.src in g)){f++;g[d.src]=true}}this._metrics.push("in="+f);this._metrics.push("dn="+document.getElementsByTagName("*").length)};a.prototype._browser=function(){var c=this._uaMatch(navigator.userAgent);var e=c.browser;if(e=="msie"){if(document.documentMode){var d=c.version.substring(0,1);if(window.performance){e+="9.0";this._metrics.push("ebrowser="+d+"9"+document.documentMode)}else{e+="8.0";this._metrics.push("ebrowser="+d+"8"+document.documentMode)}}else{e+=c.version}}var f={"msie6.0":16,"msie7.0":17,"msie8.0":18,"msie9.0":19,chrome:20,mozilla:30,safari:40,opera:50};this._metrics.push("browser="+(f[e]||0))};a.prototype._uaMatch=function(f){var e=/(chrome)\/(\d+\.\d)/,j=/(\d+\.\d)?(?:\.\d)?\s+safari\/?(\d+\.\d+)?/,i=/(opera)(?:.*version)?[ \/]([\w.]+)/,g=/(msie) ([\w.]+)/,h=/(mozilla)(?:.*? rv:([\w.]+))?/,f=f.toLowerCase(),c={};var d=e.exec(f)||i.exec(f)||g.exec(f)||f.indexOf("compatible")<0&&h.exec(f)||[];if(j.test(f)&&!/chrome/.test(f)){d[1]="safari";d[2]=RegExp["$1"]||RegExp["$2"]}return{browser:d[1]||"unknown",version:d[2]||"0"}};a.prototype._cache=function(){function l(c,m){var n=new Date();n.setTime(new Date().getTime()+30*86400000);document.cookie=c+"="+escape(m)+";path=/;expires="+n.toGMTString()}function h(m){var c=document.cookie.match(new RegExp("(^| )"+m+"=([^;]*)(;|$)"));if(c!=null){return unescape(c[2])}return null}var b=0,d=0,g=h("PMS_Cache"),k=new Date()*1;var e=new Image(),i,j,f=this;if(g){d=1}else{l("PMS_Cache",k);g=k}e.onload=function(){j=new Date();if(j-i<=1000){b=1}f._metrics.push("cache="+b);f._ready()};e.onerror=function(){f._ready()};i=new Date();e.src="http://static.tieba.baidu.com/cache_monitor?c="+g;f._metrics.push("cookie="+d)};a.prototype.send=function(){if(a._is_send){return}a._is_send=true;var d=this._data.env,e=this._metrics,f=this._connection_num;for(var c in d){e.push(c+"="+d[c])}if(window._trace_page_logid){e.push("logid="+_trace_page_logid)}e.push("pf="+navigator.platform);e.push("_t="+new Date()*1);var b=document.createElement("img");b.src=this._conf.log_path+"?"+e.join("&");window["___pms_img_"+new Date()*1]=b};a.prototype.sendCpu=function(){if(a._is_send_Cpu||!window.CPU_MONITOR||(CPU_MONITOR.length&&!CPU_MONITOR.length())){return}a._is_send_Cpu=true;var d=this._data.env,e=[];for(var c in d){e.push(c+"="+d[c])}e.push("_cpu1="+CPU_MONITOR.toString());var b=document.createElement("img");b.src=this._conf.log_path+"?"+e.join("&");window["___pms_img_"+new Date()*1]=b};if(!window.WPO_PDA){window.WPO_PDA=new a(PDC.metadata())}})();